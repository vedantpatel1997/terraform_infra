# -----------------------------------------------------------------------------
# Terraform workflow quick reference
# -----------------------------------------------------------------------------
# Authenticate with Azure using az login or exported ARM_* variables
az login

# Optional: create a service principal for automation and grant roles as needed
# az ad sp create-for-rbac --name "sp-terraform-hub-spoke" --role Contributor --scopes /subscriptions/<spoke-subscription>
# az role assignment create --assignee <appId> --role "Network Contributor" --scope /subscriptions/<hub-subscription>/resourceGroups/<hub-rg>/providers/Microsoft.Network/virtualNetworks/<hub-vnet>
# az role assignment create --assignee <appId> --role "Storage Blob Data Contributor" --scope /subscriptions/<spoke-subscription>/resourceGroups/<state-rg>/providers/Microsoft.Storage/storageAccounts/<state-storage>

# -----------------------------------------------------------------------------
# Core networking (infra-core)
# -----------------------------------------------------------------------------
cd infra-core/common
terraform init
terraform plan -out=tfplan
terraform apply tfplan

cd ../dev
terraform init
terraform plan -out=tfplan
terraform apply tfplan

cd ../prod
terraform init
terraform plan -out=tfplan
terraform apply tfplan

# -----------------------------------------------------------------------------
# Shared services (infra-shared)
# -----------------------------------------------------------------------------
cd ../../infra-shared/common
terraform init
terraform plan -out=tfplan
terraform apply tfplan

# -----------------------------------------------------------------------------
# Application layers (infra-apps)
# -----------------------------------------------------------------------------
cd ../../infra-apps/dev
terraform init
terraform plan -out=tfplan
terraform apply tfplan

cd ../prod
terraform init
terraform plan -out=tfplan
terraform apply tfplan

# -----------------------------------------------------------------------------
# Additional useful commands
# -----------------------------------------------------------------------------
terraform fmt
terraform validate
terraform output
terraform destroy -auto-approve
